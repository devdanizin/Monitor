<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Painel de Admin - Usu√°rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
          background: #f8f9fa;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h2 {
          color: #2c3e50;
          font-weight: 700;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          user-select: none;
          animation: fadeInDown 0.7s ease forwards;
        }
        .container {
          max-width: 960px;
          animation: fadeIn 0.8s ease forwards;
        }
        .senha-box {
          position: relative;
        }
        .toggle-senha {
          position: absolute;
          top: 50%;
          right: 1rem;
          transform: translateY(-50%);
          cursor: pointer;
          user-select: none;
          font-size: 1.3rem;
          color: #6c757d;
          transition: color 0.3s ease;
        }
        .toggle-senha:hover {
          color: #0d6efd;
        }
        /* Bot√£o Novo Usu√°rio com leve hover */
        .btn-success {
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-success:hover {
          transform: scale(1.05);
          box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
        }
        /* Tabela animada */
        table.table-hover tbody tr {
          opacity: 0;
          transform: translateY(10px);
          animation: fadeInUp 0.5s ease forwards;
        }
        table.table-hover tbody tr:nth-child(even) {
          animation-delay: 0.2s;
        }
        table.table-hover tbody tr:nth-child(odd) {
          animation-delay: 0.4s;
        }
        /* Modal com fade e zoom */
        .modal-content {
          border-radius: 1rem;
          box-shadow: 0 0 20px rgba(0,0,0,0.1);
          animation: zoomIn 0.35s ease forwards;
        }
        /* Anima√ß√µes Keyframes */
        @keyframes fadeInDown {
          from {opacity: 0; transform: translateY(-15px);}
          to {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeIn {
          from {opacity: 0;}
          to {opacity: 1;}
        }
        @keyframes fadeInUp {
          from {opacity: 0; transform: translateY(10px);}
          to {opacity: 1; transform: translateY(0);}
        }
        @keyframes zoomIn {
          from {opacity: 0; transform: scale(0.9);}
          to {opacity: 1; transform: scale(1);}
        }
    </style>
</head>
<body>

<!-- Toast Container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    <div id="toast-container"></div>
</div>

<div class="container mt-5">
    <h2 class="mb-4">üë®‚Äçüíº Painel de Admin - Gerenciar Usu√°rios</h2>

    <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
        <input type="text" id="filtro" class="form-control w-50" placeholder="üîç Buscar usu√°rio..." />
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNovo">+ Novo Usu√°rio</button>
        <button id="btnExportarCSV" class="btn btn-outline-primary">üì• Exportar CSV</button>
    </div>

    <table class="table table-hover table-striped align-middle">
        <thead class="table-dark">
        <tr>
            <th>Nome</th>
            <th>Perfil</th>
            <th>Senha</th>
            <th>Limite</th>
            <th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody id="lista-usuarios"></tbody>
    </table>
</div>

<!-- Modal Adicionar Usu√°rio -->
<div class="modal fade" id="modalNovo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-primary">‚ûï Adicionar Novo Usu√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4">
                <form id="form-novo-usuario" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="username" class="form-label fw-semibold">Nome</label>
                        <input
                                type="text"
                                id="username"
                                class="form-control form-control-lg"
                                placeholder="Digite o nome"
                                required
                        />
                        <div class="invalid-feedback">Por favor, insira o nome.</div>
                    </div>

                    <div class="mb-3 position-relative senha-box">
                        <label for="senha" class="form-label fw-semibold">Senha</label>
                        <input
                                type="password"
                                id="senha"
                                class="form-control form-control-lg"
                                placeholder="Digite a senha"
                                required
                        />
                        <i
                                class="bi bi-eye toggle-senha position-absolute top-50 end-3 translate-middle-y"
                                style="cursor:pointer; user-select:none; font-size: 1.25rem;"
                                id="toggleNovaSenha"
                                aria-label="Mostrar/ocultar senha"
                        ></i>
                        <div class="invalid-feedback">Por favor, insira a senha.</div>
                    </div>

                    <div class="mb-3">
                        <label for="discord_channel_id" class="form-label fw-semibold">Discord Channel ID</label>
                        <input
                                type="text"
                                id="discord_channel_id"
                                class="form-control form-control-lg"
                                placeholder="ID do canal Discord"
                                required
                        />
                        <div class="invalid-feedback">Por favor, insira o Discord Channel ID.</div>
                    </div>

                    <div class="mb-3">
                        <label for="limited" class="form-label fw-semibold">Limite</label>
                        <input
                                type="number"
                                id="limited"
                                class="form-control form-control-lg"
                                placeholder="Digite o limite"
                                required
                                min="0"
                        />
                        <div class="invalid-feedback">Por favor, insira um limite v√°lido.</div>
                    </div>

                    <div class="mb-4">
                        <label for="role" class="form-label fw-semibold">Perfil</label>
                        <select id="role" class="form-select form-select-lg">
                            <option value="USER" selected>Usu√°rio</option>
                            <option value="ADMIN">Administrador</option>
                        </select>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="plan" checked>
                        <label class="form-check-label fw-semibold" for="plan">Plano Ativo</label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 fw-semibold shadow-sm">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Visualizar Usu√°rio -->
<div class="modal fade" id="modalVisualizar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 d-flex justify-content-between align-items-center">
                <h5 class="modal-title fw-bold text-primary">üëÅÔ∏è Visualizar Usu√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4">
                <dl class="row mb-3">
                    <dt class="col-sm-4">Nome:</dt>
                    <dd class="col-sm-8" id="viewUsername"></dd>

                    <dt class="col-sm-4">Perfil:</dt>
                    <dd class="col-sm-8" id="viewRole"></dd>

                    <dt class="col-sm-4">Limite:</dt>
                    <dd class="col-sm-8" id="viewLimited"></dd>

                    <dt class="col-sm-4">Discord Channel ID:</dt>
                    <dd class="col-sm-8" id="viewDiscordChannelId"></dd>
                </dl>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="viewPlan">
                    <label class="form-check-label fw-semibold" for="viewPlan">Plano Ativo</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnSalvarPlan" type="button" class="btn btn-primary">Salvar Altera√ß√£o do Plano</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclus√£o -->
<div class="modal fade" id="modalConfirmDelete" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title text-danger fw-bold">‚ö†Ô∏è Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4">
                <p id="confirmDeleteMessage" class="mb-0">Tem certeza que deseja excluir este usu√°rio?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDelete">Excluir</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = '/api/admin/usuarios';
    const usuarioLogado = 'admin';

    let usuarioParaExcluirId = null;
    let usuarioVisualizadoId = null;

    function showToast(message, type = 'success', delay = 3000) {
      const toastId = 'toast-' + Date.now();
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
          </div>
        </div>
      `;
      $('#toast-container').append(toastHtml);
      const toastElement = document.getElementById(toastId);
      const bsToast = new bootstrap.Toast(toastElement);
      bsToast.show();

      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }

    function carregarUsuarios() {
      $.get(API_URL, function (data) {
        const lista = $('#lista-usuarios').empty();
        if (!data.length) {
          lista.append('<tr><td colspan="5" class="text-center text-muted">Nenhum usu√°rio encontrado.</td></tr>');
          return;
        }

        data.forEach((u, i) => {
          const podeExcluir = u.username !== usuarioLogado && u.role !== 'ADMIN';
          const linha = $(`
            <tr style="animation-delay: ${i * 0.1}s;">
              <td>${u.username}</td>
              <td><span class="badge ${u.role === 'ADMIN' ? 'bg-danger' : 'bg-secondary'}">${u.role}</span></td>
              <td class="senha-box">
                <input type="password" readonly class="form-control form-control-sm" value="${u.password}" style="max-width:160px;" />
                <i class="bi bi-eye toggle-senha"></i>
              </td>
              <td>${u.limited ?? '-'}</td>
              <td>
                <button class="btn btn-sm btn-outline-info btn-view" data-id="${u.id}" title="Visualizar usu√°rio"><i class="bi bi-eye"></i></button>
                ${podeExcluir ? `<button class="btn btn-sm btn-outline-danger btn-delete" data-id="${u.id}" data-username="${u.username}" title="Excluir usu√°rio"><i class="bi bi-trash"></i></button>` : ''}
              </td>
            </tr>
          `);

          // Toggle senha mostrar/ocultar
          linha.find('.toggle-senha').click(function () {
            const input = $(this).siblings('input');
            const isPassword = input.attr('type') === 'password';
            input.attr('type', isPassword ? 'text' : 'password');
            $(this).toggleClass('bi-eye bi-eye-slash');
          });

          // Visualizar usu√°rio (modal)
          linha.find('.btn-view').click(function () {
            usuarioVisualizadoId = u.id;
            $('#viewUsername').text(u.username);
            $('#viewRole').text(u.role);
            $('#viewLimited').text(u.limited ?? '-');
            $('#viewDiscordChannelId').text(u.discordChannelId ?? '-');
            $('#viewPlan').prop('checked', !!u.plan);

            const modalVisualizar = new bootstrap.Modal(document.getElementById('modalVisualizar'));
            modalVisualizar.show();
          });

          // Excluir usu√°rio
          linha.find('.btn-delete').click(function () {
            usuarioParaExcluirId = $(this).data('id');
            const usernameExcluir = $(this).data('username');
            $('#confirmDeleteMessage').text(`Tem certeza que deseja excluir o usu√°rio "${usernameExcluir}"?`);

            const modalConfirmDelete = new bootstrap.Modal(document.getElementById('modalConfirmDelete'));
            modalConfirmDelete.show();
          });

          lista.append(linha);
        });
      });
    }

    // Bot√£o confirmar exclus√£o no modal
    $('#btnConfirmDelete').click(function () {
      if (!usuarioParaExcluirId) return;

      $.ajax({
        url: API_URL + '/' + usuarioParaExcluirId,
        type: 'DELETE',
        success: () => {
          usuarioParaExcluirId = null;
          const modalConfirmDelete = bootstrap.Modal.getInstance(document.getElementById('modalConfirmDelete'));
          modalConfirmDelete.hide();
          carregarUsuarios();
          showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
        },
        error: (xhr) => {
          showToast('Erro ao excluir: ' + xhr.responseText, 'danger');
        }
      });
    });

    // Formul√°rio novo usu√°rio
    $('#form-novo-usuario').submit(function (e) {
      e.preventDefault();
      if (!this.checkValidity()) {
        e.stopPropagation();
        $(this).addClass('was-validated');
        return;
      }
      const username = $('#username').val();
      const password = $('#senha').val();
      const role = $('#role').val();
      const limited = parseInt($('#limited').val());
      const discord_channel_id = $('#discord_channel_id').val();
      const plan = $('#plan').is(':checked');

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ username, password, role, limited, discordChannelId: discord_channel_id, plan }),
        success: () => {
          const modalNovo = bootstrap.Modal.getInstance(document.getElementById('modalNovo'));
          modalNovo.hide();
          this.reset();
          $(this).removeClass('was-validated');
          carregarUsuarios();
          showToast('Usu√°rio criado com sucesso!', 'success');
        },
        error: (xhr) => showToast('Erro ao criar: ' + xhr.responseText, 'danger'),
      });
    });

    // Toggle mostrar/ocultar senha novo usu√°rio
    $('#toggleNovaSenha').click(function () {
      const input = $('#senha');
      const isPassword = input.attr('type') === 'password';
      input.attr('type', isPassword ? 'text' : 'password');
      $(this).toggleClass('bi-eye bi-eye-slash');
    });

    // Filtro de busca
    $('#filtro').on('input', function () {
      const termo = $(this).val().toLowerCase();
      $('#lista-usuarios tr').each(function () {
        const user = $(this).find('td:first').text().toLowerCase();
        $(this).toggle(user.includes(termo));
      });
    });

    // Bot√£o salvar altera√ß√£o do plano no modal de visualiza√ß√£o
    $('#btnSalvarPlan').click(function () {
      if (usuarioVisualizadoId === null) return;
      const novoPlan = $('#viewPlan').is(':checked');

      $.ajax({
        url: `${API_URL}/${usuarioVisualizadoId}/plan`,
        type: 'PATCH',
        contentType: 'application/json',
        data: JSON.stringify({ plan: novoPlan }),
        success: () => {
          showToast('Plano atualizado com sucesso!', 'success');
          const modalVisualizar = bootstrap.Modal.getInstance(document.getElementById('modalVisualizar'));
          modalVisualizar.hide();
          carregarUsuarios();
        },
        error: (xhr) => showToast('Erro ao atualizar plano: ' + xhr.responseText, 'danger'),
      });
    });

    // Bot√£o exportar CSV
    $('#btnExportarCSV').click(function () {
      $.get(API_URL, function (data) {
        if (!data.length) {
          showToast('Nenhum usu√°rio para exportar.', 'warning');
          return;
        }
        let csv = 'Nome,Perfil,Senha,Limite,Discord Channel ID,Plano Ativo\n';
        data.forEach(u => {
          csv += `"${u.username}","${u.role}","${u.password}","${u.limited ?? ''}","${u.discordChannelId ?? ''}","${u.plan ? 'Sim' : 'N√£o'}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'usuarios.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('CSV exportado com sucesso!', 'success');
      });
    });

    // Inicializa√ß√£o
    $(document).ready(() => {
      carregarUsuarios();
    });
</script>
</body>
</html>