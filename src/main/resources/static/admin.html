<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Painel de Admin - Usu√°rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
          background: #f8f9fa;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h2 {
          color: #2c3e50;
          font-weight: 700;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          user-select: none;
          animation: fadeInDown 0.7s ease forwards;
        }
        .container {
          max-width: 960px;
          animation: fadeIn 0.8s ease forwards;
        }
        .senha-box {
          position: relative;
        }
        .toggle-senha {
          position: absolute;
          top: 50%;
          right: 1rem;
          transform: translateY(-50%);
          cursor: pointer;
          user-select: none;
          font-size: 1.3rem;
          color: #6c757d;
          transition: color 0.3s ease;
        }
        .toggle-senha:hover {
          color: #0d6efd;
        }
        .btn-success {
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-success:hover {
          transform: scale(1.05);
          box-shadow: 0 0 8px rgba(25, 135, 84, 0.6);
        }
        table.table-hover tbody tr {
          opacity: 0;
          transform: translateY(10px);
          animation: fadeInUp 0.5s ease forwards;
        }
        table.table-hover tbody tr:nth-child(even) {
          animation-delay: 0.2s;
        }
        table.table-hover tbody tr:nth-child(odd) {
          animation-delay: 0.4s;
        }
        .modal-content {
          border-radius: 1rem;
          box-shadow: 0 0 20px rgba(0,0,0,0.1);
          animation: zoomIn 0.35s ease forwards;
        }
        @keyframes fadeInDown {
          from {opacity: 0; transform: translateY(-15px);}
          to {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeIn {
          from {opacity: 0;}
          to {opacity: 1;}
        }
        @keyframes fadeInUp {
          from {opacity: 0; transform: translateY(10px);}
          to {opacity: 1; transform: translateY(0);}
        }
        @keyframes zoomIn {
          from {opacity: 0; transform: scale(0.9);}
          to {opacity: 1; transform: scale(1);}
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">üë®‚Äçüíº Painel de Admin - Gerenciar Usu√°rios</h2>

    <div class="d-flex justify-content-between mb-3">
        <input type="text" id="filtro" class="form-control w-50" placeholder="üîç Buscar usu√°rio..." />
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNovo">+ Novo Usu√°rio</button>
    </div>

    <table class="table table-hover table-striped">
        <thead class="table-dark">
        <tr>
            <th>Nome</th>
            <th>Perfil</th>
            <th>Senha</th>
            <th>Limite</th>
            <th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody id="lista-usuarios"></tbody>
    </table>
</div>

<!-- Modal Adicionar Usu√°rio -->
<div class="modal fade" id="modalNovo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-primary">‚ûï Adicionar Novo Usu√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4">
                <form id="form-novo-usuario" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="username" class="form-label fw-semibold">Nome</label>
                        <input
                                type="text"
                                id="username"
                                class="form-control form-control-lg"
                                placeholder="Digite o nome"
                                required
                        />
                        <div class="invalid-feedback">Por favor, insira o nome.</div>
                    </div>

                    <div class="mb-3 position-relative senha-box">
                        <label for="senha" class="form-label fw-semibold">Senha</label>
                        <input
                                type="password"
                                id="senha"
                                class="form-control form-control-lg"
                                placeholder="Digite a senha"
                                required
                        />
                        <i
                                class="bi bi-eye toggle-senha position-absolute top-50 end-3 translate-middle-y"
                                style="cursor:pointer; user-select:none; font-size: 1.25rem;"
                                id="toggleNovaSenha"
                                aria-label="Mostrar/ocultar senha"
                        ></i>
                        <div class="invalid-feedback">Por favor, insira a senha.</div>
                    </div>

                    <div class="mb-3">
                        <label for="discord_channel_id" class="form-label fw-semibold">Discord Channel ID</label>
                        <input
                                type="text"
                                id="discord_channel_id"
                                class="form-control form-control-lg"
                                placeholder="ID do canal Discord"
                                required
                        />
                        <div class="invalid-feedback">Por favor, insira o Discord Channel ID.</div>
                    </div>

                    <div class="mb-3">
                        <label for="limited" class="form-label fw-semibold">Limite</label>
                        <input
                                type="number"
                                id="limited"
                                class="form-control form-control-lg"
                                placeholder="Digite o limite"
                                required
                                min="0"
                        />
                        <div class="invalid-feedback">Por favor, insira um limite v√°lido.</div>
                    </div>

                    <div class="mb-4">
                        <label for="role" class="form-label fw-semibold">Perfil</label>
                        <select id="role" class="form-select form-select-lg">
                            <option value="USER" selected>Usu√°rio</option>
                            <option value="ADMIN">Administrador</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100 fw-semibold shadow-sm">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Visualizar Usu√°rio -->
<div class="modal fade" id="modalVisualizar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-primary">üëÅÔ∏è Visualizar Usu√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Nome:</dt>
                    <dd class="col-sm-8" id="viewUsername"></dd>

                    <dt class="col-sm-4">Perfil:</dt>
                    <dd class="col-sm-8" id="viewRole"></dd>

                    <dt class="col-sm-4">Senha:</dt>
                    <dd class="col-sm-8 senha-box">
                        <input type="password" readonly class="form-control form-control-sm" id="viewPassword" style="max-width:160px; display:inline-block;" />
                        <i class="bi bi-eye toggle-senha" id="toggleViewSenha" style="cursor:pointer; font-size:1.2rem; vertical-align:middle; margin-left:6px;" aria-label="Mostrar/ocultar senha"></i>
                    </dd>

                    <dt class="col-sm-4">Limite:</dt>
                    <dd class="col-sm-8" id="viewLimited"></dd>

                    <dt class="col-sm-4">Discord Channel ID:</dt>
                    <dd class="col-sm-8" id="viewDiscord"></dd>
                </dl>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Exclus√£o -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-hidden="true" aria-labelledby="modalConfirmarExclusaoLabel">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-danger" id="modalConfirmarExclusaoLabel">‚ö†Ô∏è Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body px-5 pt-0 pb-4" id="textoConfirmacao">
                <!-- Texto din√¢mico aqui -->
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExcluir">Excluir</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api/admin/usuarios';
    const usuarioLogado = 'admin';

    let usuarioParaExcluirId = null; // guarda id para exclus√£o ap√≥s confirma√ß√£o

    function carregarUsuarios() {
      $.get(API_URL, function (data) {
        const lista = $('#lista-usuarios').empty();
        if (!data.length) {
          lista.append('<tr><td colspan="5" class="text-center text-muted">Nenhum usu√°rio encontrado.</td></tr>');
          return;
        }

        data.forEach((u, i) => {
          const podeExcluir = u.username !== usuarioLogado && u.role !== 'ADMIN';

          const linha = $(`
            <tr style="animation-delay: ${i * 0.1}s;">
              <td>${u.username}</td>
              <td><span class="badge ${u.role === 'ADMIN' ? 'bg-danger' : 'bg-secondary'}">${u.role}</span></td>
              <td class="senha-box">
                <input type="password" readonly class="form-control form-control-sm" value="${u.password}" style="max-width:160px; display:inline-block;" />
                <i class="bi bi-eye toggle-senha" style="cursor:pointer; font-size:1.1rem; vertical-align:middle; margin-left:6px;"></i>
              </td>
              <td>${u.limited ?? '-'}</td>
              <td>
                <button class="btn btn-sm btn-info btn-view me-1" title="Visualizar usu√°rio" aria-label="Visualizar usu√°rio ${u.username}" data-id="${u.id}" data-username="${u.username}" data-role="${u.role}" data-password="${u.password}" data-limited="${u.limited ?? '-'}" data-discord="${u.discord_channel_id ?? '-'}">
                  <i class="bi bi-eye"></i>
                </button>
                ${podeExcluir ? `<button class="btn btn-sm btn-outline-danger btn-delete" title="Excluir usu√°rio" aria-label="Excluir usu√°rio ${u.username}" data-id="${u.id}" data-username="${u.username}"><i class="bi bi-trash"></i></button>` : ''}
              </td>
            </tr>
          `);

          // Toggle senha no input da lista
          linha.find('.toggle-senha').click(function () {
            const input = $(this).siblings('input');
            const isPassword = input.attr('type') === 'password';
            input.attr('type', isPassword ? 'text' : 'password');
            $(this).toggleClass('bi-eye bi-eye-slash');
          });

          // Abrir modal visualizar
          linha.find('.btn-view').click(function () {
            const btn = $(this);
            $('#viewUsername').text(btn.data('username'));
            $('#viewRole').text(btn.data('role'));
            $('#viewPassword').val(btn.data('password')).attr('type', 'password');
            $('#toggleViewSenha').removeClass('bi-eye-slash').addClass('bi-eye');
            $('#viewLimited').text(btn.data('limited'));
            $('#viewDiscord').text(btn.data('discord'));
            const modalVisualizar = new bootstrap.Modal(document.getElementById('modalVisualizar'));
            modalVisualizar.show();
          });

          // Abrir modal confirma√ß√£o exclus√£o
          linha.find('.btn-delete').click(function () {
            usuarioParaExcluirId = $(this).data('id');
            const nomeUsuario = $(this).data('username');
            $('#textoConfirmacao').text(`Tem certeza que deseja excluir o usu√°rio "${nomeUsuario}"? Essa a√ß√£o n√£o pode ser desfeita.`);
            const modalConfirm = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
            modalConfirm.show();
          });

          lista.append(linha);
        });
      });
    }

    // Confirmar exclus√£o ao clicar no bot√£o do modal
    $('#btnConfirmarExcluir').click(function () {
      if (!usuarioParaExcluirId) return;
      $.ajax({
        url: API_URL + '/' + usuarioParaExcluirId,
        type: 'DELETE',
        success: () => {
          usuarioParaExcluirId = null;
          carregarUsuarios();
          const modalConfirmEl = document.getElementById('modalConfirmarExclusao');
          const modalConfirm = bootstrap.Modal.getInstance(modalConfirmEl);
          modalConfirm.hide();
        },
        error: (xhr) => alert('Erro ao excluir: ' + xhr.responseText),
      });
    });

    $('#form-novo-usuario').submit(function (e) {
      e.preventDefault();
      if (!this.checkValidity()) {
        e.stopPropagation();
        $(this).addClass('was-validated');
        return;
      }
      const username = $('#username').val();
      const password = $('#senha').val();
      const role = $('#role').val();
      const limited = $('#limited').val();
      const discord_channel_id = $('#discord_channel_id').val();

      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ username, password, role, limited, discord_channel_id }),
        success: () => {
          const modalNovoEl = document.getElementById('modalNovo');
          const modalNovo = bootstrap.Modal.getInstance(modalNovoEl);
          modalNovo.hide();
          this.reset();
          $(this).removeClass('was-validated');
          carregarUsuarios();
        },
        error: (xhr) => alert('Erro ao criar: ' + xhr.responseText),
      });
    });

    $('#toggleNovaSenha').click(function () {
      const input = $('#senha');
      const isPassword = input.attr('type') === 'password';
      input.attr('type', isPassword ? 'text' : 'password');
      $(this).toggleClass('bi-eye bi-eye-slash');
    });

    // Toggle senha no modal visualizar
    $('#toggleViewSenha').click(function () {
      const input = $('#viewPassword');
      const isPassword = input.attr('type') === 'password';
      input.attr('type', isPassword ? 'text' : 'password');
      $(this).toggleClass('bi-eye bi-eye-slash');
    });

    $('#filtro').on('input', function () {
      const termo = $(this).val().toLowerCase();
      $('#lista-usuarios tr').each(function () {
        const user = $(this).find('td:first').text().toLowerCase();
        $(this).toggle(user.includes(termo));
      });
    });

    $(document).ready(() => {
      carregarUsuarios();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>