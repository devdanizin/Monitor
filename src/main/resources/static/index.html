<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitor Web - Dashboard Clean</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        @media (max-width: 768px) {
          .main-content {
            padding: 1.5rem 1.5rem;
            border-radius: 0;
          }
          .sidebar {
            width: 60px;
            padding: 1rem 0;
          }
          .sidebar button {
            font-size: 1.5rem;
          }
        }

        /* Novas melhorias para tablets (largura entre 480px e 768px) */
        @media (max-width: 768px) and (min-width: 481px) {
          .main-content {
            padding: 1.5rem 2rem;
          }
          #url-form {
            flex-direction: column;
            align-items: stretch;
          }
          #url-form input[type=url] {
            max-width: 100%;
            flex-grow: 0;
          }
          #url-form button {
            width: 100%;
          }
          #lista-urls li {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
          }
          #lista-urls li button {
            align-self: flex-end;
          }
        }

        /* Para smartphones (largura até 480px) */
        @media (max-width: 480px) {
          .app {
            flex-direction: column;
            height: auto;
          }

          .sidebar {
            width: 100%;
            height: 56px;
            flex-direction: row;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
            border-right: none;
            border-bottom: 1px solid #d6dde9;
            user-select: none;
          }
          .sidebar button {
            font-size: 1.5rem;
            padding: 0.5rem;
          }

          .main-content {
            flex: none;
            height: auto;
            border-radius: 0;
            padding: 1rem 1rem 2rem;
          }

          /* Tabs horizontais maior espaçamento */
          .tab-list {
            gap: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
          }
          .tab-list button {
            flex: none;
            padding: 0.5rem 1rem;
            font-size: 1rem;
          }

          /* Form URL: coluna, campo e botão larguras 100% */
          #url-form {
            flex-direction: column;
            align-items: stretch;
          }
          #url-form input[type=url] {
            max-width: 100%;
            flex-grow: 0;
          }
          #url-form button {
            width: 100%;
          }

          /* Lista URLs com itens empilhados */
          #lista-urls li {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.95rem;
          }
          #lista-urls li button {
            align-self: flex-end;
          }

          /* Cards monitoramento */
          .monitor-card {
            padding: 1rem 1.2rem;
            font-size: 0.95rem;
          }

          /* Canvas gráfico responsivo */
          #statusChart {
            max-height: 240px !important;
          }
        }

        /* Reset */
        * {
          box-sizing: border-box;
        }
        body, html {
          margin: 0; padding: 0;
          height: 100%;
          font-family: 'Inter', sans-serif;
          background: #f9fbfc;
          color: #34495e;
        }

        /* Layout geral */
        .app {
          display: flex;
          height: 100vh;
          overflow: hidden;
        }

        /* Sidebar vertical minimalista */
        .sidebar {
          width: 72px;
          background: #e6f0fa;
          border-right: 1px solid #d6dde9;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 1.5rem 0;
          gap: 1.5rem;
          box-shadow: inset -2px 0 4px #b0c3de;
          user-select: none;
        }

        .sidebar button {
          background: transparent;
          border: none;
          font-size: 1.8rem;
          color: #8aa3bf;
          cursor: pointer;
          padding: 0.2rem;
          transition: color 0.3s ease;
        }
        .sidebar button[aria-current="page"],
        .sidebar button:hover,
        .sidebar button:focus {
          color: #3a79f7;
          outline: none;
          filter: drop-shadow(0 0 3px #3a79f7aa);
        }
        .sidebar button:focus-visible {
          outline: 2px solid #3a79f7;
          outline-offset: 2px;
        }

        /* Conteúdo principal */
        .main-content {
          flex: 1;
          padding: 2.5rem 3rem;
          overflow-y: auto;
          background: #fff;
          border-radius: 0 12px 12px 0;
          box-shadow: inset 0 0 20px #dde6f4;
          display: flex;
          flex-direction: column;
          gap: 1.5rem;
        }

        /* Top tabs horizontal */
        .tab-list {
          display: flex;
          gap: 2.5rem;
          border-bottom: 2px solid #e3eaf7;
          padding-bottom: 0.5rem;
          margin-bottom: 1rem;
        }

        .tab-list button {
          background: none;
          border: none;
          font-weight: 600;
          font-size: 1.1rem;
          color: #7a8ba6;
          cursor: pointer;
          padding: 0.3rem 0.8rem;
          border-bottom: 3px solid transparent;
          transition: all 0.3s ease;
        }
        .tab-list button[aria-selected="true"] {
          color: #3a79f7;
          border-bottom-color: #3a79f7;
          filter: drop-shadow(0 0 5px #3a79f7bb);
          cursor: default;
        }
        .tab-list button:focus-visible {
          outline-offset: 4px;
          outline: 3px solid #3a79f7aa;
          border-radius: 4px;
        }

        /* Sections abas */
        .tab-panel {
          flex-grow: 1;
          display: none;
          overflow-y: auto;
          scrollbar-width: thin;
          scrollbar-color: #a0b4e8 #f1f4fc;
        }
        .tab-panel.active {
          display: block;
        }
        .tab-panel::-webkit-scrollbar {
          width: 8px;
        }
        .tab-panel::-webkit-scrollbar-track {
          background: #f1f4fc;
          border-radius: 8px;
        }
        .tab-panel::-webkit-scrollbar-thumb {
          background-color: #a0b4e8;
          border-radius: 8px;
        }

        h2 {
          font-weight: 700;
          color: #3a4975;
          margin-bottom: 1.25rem;
          letter-spacing: 0.03em;
        }

        /* Inputs e selects */
        input[type=date],
        select,
        input[type=url] {
          border: 1.5px solid #cbd6ea;
          border-radius: 8px;
          padding: 0.5rem 1rem;
          font-size: 1rem;
          transition: border-color 0.3s ease;
          width: 100%;
          max-width: 280px;
          background-color: #f9fbfc;
          color: #34495e;
        }
        input[type=date]:focus,
        select:focus,
        input[type=url]:focus {
          outline: none;
          border-color: #3a79f7;
          box-shadow: 0 0 6px #3a79f7aa;
          background-color: #fff;
        }

        /* Botões */
        button.btn-primary {
          background: #3a79f7;
          border: none;
          padding: 0.55rem 1.3rem;
          border-radius: 8px;
          font-weight: 600;
          color: #fff;
          cursor: pointer;
          transition: background 0.3s ease;
          box-shadow: 0 3px 6px #3a79f7bb;
          font-size: 1rem;
        }
        button.btn-primary:hover,
        button.btn-primary:focus {
          background: #295fcb;
          box-shadow: 0 6px 10px #295fcbcc;
          outline: none;
        }
        button.btn-sm {
          background: #e74c3c;
          border: none;
          color: #fff;
          padding: 0.25rem 0.7rem;
          font-size: 0.85rem;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
          transition: background 0.25s ease;
          box-shadow: 0 2px 6px #e74c3caa;
        }
        button.btn-sm:hover,
        button.btn-sm:focus {
          background: #bf3a2b;
          box-shadow: 0 4px 8px #bf3a2bcc;
          outline: none;
        }

        /* Form adicionar URL */
        #url-form {
          display: flex;
          gap: 1rem;
          flex-wrap: wrap;
          align-items: center;
          margin-bottom: 1rem;
        }
        #url-form input[type=url] {
          flex-grow: 1;
          min-width: 280px;
        }

        /* Lista URLs */
        #lista-urls {
          max-height: 60vh;
          overflow-y: auto;
          list-style: none;
          padding: 0;
          margin: 0;
          border: 1px solid #d0d8e7;
          border-radius: 12px;
          background: #f9fbfc;
          box-shadow: inset 0 2px 6px #dce5f2;
        }
        #lista-urls li {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.9rem 1.2rem;
          border-bottom: 1px solid #d0d8e7;
          font-weight: 600;
          font-size: 1rem;
          color: #3a4975;
          transition: background-color 0.15s ease;
        }
        #lista-urls li:last-child {
          border-bottom: none;
        }
        #lista-urls li:hover,
        #lista-urls li:focus-within {
          background-color: #e4ecff;
          outline: none;
        }

        /* Cartões monitoramento */
        .monitor-card {
          background: #ffffff;
          border-radius: 12px;
          box-shadow: 0 6px 15px rgb(58 73 117 / 0.08);
          padding: 1.4rem 2rem;
          margin-bottom: 1rem;
          transition: box-shadow 0.3s ease;
          cursor: default;
          color: #3a4975;
        }
        .monitor-card:hover,
        .monitor-card:focus-within {
          box-shadow: 0 12px 25px rgb(58 73 117 / 0.18);
          outline: none;
        }

        .monitor-url {
          font-weight: 700;
          font-size: 1.25rem;
          margin-bottom: 0.3rem;
          word-break: break-word;
        }

        .status-badge {
          display: inline-block;
          padding: 0.25rem 0.75rem;
          border-radius: 20px;
          font-weight: 700;
          font-size: 0.9rem;
          box-shadow: 0 0 6px #00000015;
          min-width: 60px;
          text-align: center;
        }
        .status-ok {
          background: #e4f0ff;
          color: #2374f1;
          box-shadow: 0 0 12px #2374f1aa;
        }
        .status-fail {
          background: #ffe4e4;
          color: #e13e3e;
          box-shadow: 0 0 12px #e13e3eaa;
        }

        .monitor-meta {
          font-style: italic;
          color: #7a8ba6;
          margin-top: 0.45rem;
          font-size: 0.9rem;
        }

        /* Modal */
        .modal-content {
          border-radius: 14px;
          padding: 1rem 1.2rem;
          font-size: 1rem;
          color: #34495e;
          font-weight: 600;
          box-shadow: 0 0 25px #aac4ff99;
        }
        .modal-footer button {
          border-radius: 12px;
          font-weight: 700;
          padding: 0.45rem 1.1rem;
          font-size: 1rem;
        }
        .btn-secondary {
          background: #c8d5f8;
          border: none;
          color: #3a4975;
          box-shadow: 0 3px 10px #b5c3f2aa;
          transition: background 0.3s ease;
        }
        .btn-secondary:hover,
        .btn-secondary:focus {
          background: #a6b9f5;
          color: #1f2a52;
          outline: none;
        }

        /* Toast container */
        #toast-container {
          z-index: 1300;
        }

        /* Responsividade */
        @media (max-width: 768px) {
          .main-content {
            padding: 1.5rem 1.5rem;
            border-radius: 0;
          }
          .sidebar {
            width: 60px;
            padding: 1rem 0;
          }
          .sidebar button {
            font-size: 1.5rem;
          }
        }
    </style>
</head>
<body>
<div class="app" role="application" aria-label="Aplicação Monitor Web">

    <nav class="sidebar" role="navigation"
         aria-label="Menu lateral principal">
        <button aria-current="page" aria-label="Dashboard" data-tab="dashboard"
                tabindex="0" title="Dashboard">🏠</button>
        <button aria-label="Histórico de monitoramento"
                data-tab="monitoramentos" tabindex="0" title="Histórico">📜</button>
        <button aria-label="Gerenciar URLs" data-tab="urls" tabindex="0"
                title="Gerenciar URLs">🔗</button>
    </nav>

    <main class="main-content">
        <div role="tablist" aria-label="Seletor de abas" class="tab-list">
            <button role="tab" id="tab-dashboard" aria-controls="dashboard"
                    aria-selected="true" data-tab="dashboard"
                    tabindex="0">Dashboard</button>
            <button role="tab" id="tab-monitoramentos"
                    aria-controls="monitoramentos" aria-selected="false"
                    data-tab="monitoramentos" tabindex="-1">Histórico</button>
            <button role="tab" id="tab-urls" aria-controls="urls"
                    aria-selected="false" data-tab="urls" tabindex="-1">Gerenciar
                URLs</button>
        </div>

        <section id="dashboard" class="tab-panel active" role="tabpanel"
                 tabindex="0" aria-labelledby="tab-dashboard">
            <h2>Visão Geral</h2>

            <div class="d-flex flex-wrap gap-3 mb-4">
                <label for="data-inicial" class="d-flex flex-column">
                    <span class="mb-1 fw-semibold">Data Inicial</span>
                    <input type="date" id="data-inicial"
                           aria-label="Data inicial do filtro" />
                </label>
                <label for="data-final" class="d-flex flex-column">
                    <span class="mb-1 fw-semibold">Data Final</span>
                    <input type="date" id="data-final"
                           aria-label="Data final do filtro" />
                </label>
                <label for="filtro-status" class="d-flex flex-column">
                    <span class="mb-1 fw-semibold">Status</span>
                    <select id="filtro-status" aria-label="Filtro de status">
                        <option value="todos">Todos</option>
                        <option value="ok">OK (2xx)</option>
                        <option value="falha">Falha</option>
                    </select>
                </label>
            </div>

            <canvas id="statusChart"
                    aria-label="Gráfico de status do monitoramento" role="img"
                    style="max-height:320px; width: 100%;"></canvas>
        </section>

        <section id="monitoramentos" class="tab-panel" role="tabpanel"
                 tabindex="0" aria-labelledby="tab-monitoramentos">
            <h2>Histórico de Monitoramento</h2>
            <div id="monitor-container" tabindex="0" aria-live="polite"
                 aria-atomic="true"
                 style="max-height: 65vh; overflow-y: auto; padding-right: 0.25rem;">
                <!-- Cards preenchidos via JS -->
            </div>
        </section>

        <section id="urls" class="tab-panel" role="tabpanel" tabindex="0"
                 aria-labelledby="tab-urls">
            <h2>Gerenciar URLs</h2>

            <form id="url-form" aria-label="Adicionar nova URL para monitoramento"
                  novalidate>
                <input
                        type="url"
                        id="nova-url"
                        placeholder="https://exemplo.com"
                        aria-required="true"
                        required
                        pattern="https?://.+"
                        title="Digite uma URL válida começando com http:// ou https://" />
                <button type="submit" class="btn-primary"
                        aria-label="Adicionar URL">Adicionar</button>
                <div class="invalid-feedback"
                     style="display:none; font-size:0.875rem; color:#e74c3c; margin-top:0.25rem;">
                    Por favor, insira uma URL válida.
                </div>
            </form>

            <ul id="lista-urls" tabindex="0" aria-live="polite"
                aria-atomic="true">
            </ul>
        </section>
    </main>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1"
     aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteLabel">Confirmar
                    exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir esta URL?
            </div>
            <div class="modal-footer">
                <button type="button" id="btnCancelDelete" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="btnConfirmDelete"
                        class="btn btn-sm btn-danger">Excluir</button>
            </div>
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1300;">
    <div id="toast-container"></div>
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const tabs = ["dashboard", "monitoramentos", "urls"];

    function ativarAba(tab) {
      // Sidebar
      $(".sidebar button").attr("aria-current", null);
      $(`.sidebar button[data-tab=${tab}]`).attr("aria-current", "page");

      // Tablist
      $(".tab-list button").attr({
        "aria-selected": "false",
        tabindex: -1,
      });
      $(`.tab-list button[data-tab=${tab}]`).attr({
        "aria-selected": "true",
        tabindex: 0,
      }).focus();

      // Conteúdo
      $(".tab-panel").removeClass("active");
      $(`#${tab}`).addClass("active").focus();
    }

    // Click sidebar e tabs top
    $(".sidebar button, .tab-list button").click(function () {
      const tab = $(this).data("tab");
      ativarAba(tab);
    });

    // Toast function - bootstrap toast via JS (timeout 3s)
    function showToast(msg, type = "danger") {
      const id = `toast-${Date.now()}`;
      const toastHtml = `
      <div id="${id}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
      </div>`;

      $("#toast-container").append(toastHtml);
      const toastEl = document.getElementById(id);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();

      toastEl.addEventListener("hidden.bs.toast", () => {
        $(toastEl).remove();
      });
    }

    let chart = null;
    function atualizarGrafico() {
      $.ajax({
        url: '/api/sites',
        type: 'GET',
        success: function (monitorData) {
          const dataMin = new Date($("#data-inicial").val());
          const dataMax = new Date($("#data-final").val());
          const filtroStatus = $("#filtro-status").val();

          // Filtro por status no front-end
          let filtered = monitorData;
          if (filtroStatus === "ok") filtered = monitorData.filter(m => m.statusCode >= 200 && m.statusCode < 300);
          else if (filtroStatus === "falha") filtered = monitorData.filter(m => !(m.statusCode >= 200 && m.statusCode < 300));

          // Filtro por datas
          const countsByDate = {};
          filtered.forEach(({ checkedAt, statusCode }) => {
            const dt = new Date(checkedAt);
            if (!$("#data-inicial").val() || !$("#data-final").val() || dt < dataMin || dt > dataMax) return;

            const day = dt.toISOString().slice(0, 10);
            countsByDate[day] ??= { ok: 0, fail: 0 };
            if (statusCode >= 200 && statusCode < 300) countsByDate[day].ok++;
            else countsByDate[day].fail++;
          });

          const labels = Object.keys(countsByDate).sort();
          const okCounts = labels.map(d => countsByDate[d].ok);
          const failCounts = labels.map(d => countsByDate[d].fail);

          const ctx = document.getElementById("statusChart").getContext("2d");
          if (chart) chart.destroy();

          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                { label: "OK", data: okCounts, backgroundColor: "#3a79f7" },
                { label: "Falha", data: failCounts, backgroundColor: "#e74c3c" },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                tooltip: { mode: "index", intersect: false }
              },
              scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
              }
            },
          });
        },
        error: function () {
          showToast("Erro ao carregar dados do gráfico.");
        }
      });
    }

    function carregarMonitoramentos() {
      $.ajax({
        url: "/api/sites",
        type: "GET",
        success: function (monitorData) {
          const container = $("#monitor-container").empty();
          if (!monitorData.length) {
            container.append(`<p class="text-muted fst-italic">Nenhum monitoramento encontrado.</p>`);
            return;
          }
          monitorData.forEach(({ url, statusCode, checkedAt }) => {
            const dt = new Date(checkedAt);
            const statusClass = (statusCode >= 200 && statusCode < 300) ? "status-ok" : "status-fail";

            const card = $(`
              <article tabindex="0" class="monitor-card" aria-label="Monitoramento da URL ${url}">
                <div class="monitor-url">${url}</div>
                <div class="status-badge ${statusClass}">${statusCode}</div>
                <div class="monitor-meta">Verificado em ${dt.toLocaleString()}</div>
              </article>
            `);
            container.append(card);
          });
        },
        error: function () {
          showToast("Erro ao carregar histórico de monitoramento.");
        }
      });
    }

    function carregarUrls() {
      $.ajax({
        url: "/api/monitor",
        type: "GET",
        success: function (urls) {
          const ul = $("#lista-urls").empty();
          if (!urls.length) {
            ul.append('<li class="text-muted fst-italic p-3">Nenhuma URL cadastrada.</li>');
            return;
          }
          urls.forEach(({ id, url }) => {
            ul.append(`
              <li tabindex="0" aria-label="URL ${url}" role="listitem">
                <span>${url}</span>
                <button class="btn-sm" aria-label="Excluir URL ${url}" data-id="${id}">Excluir</button>
              </li>
            `);
          });
        },
        error: function () {
          showToast("Erro ao carregar URLs.");
        }
      });
    }

    function excluirUrl(id) {
      $.ajax({
        url: `/api/sites/${id}`,
        type: "DELETE",
        success: function () {
          showToast("URL excluída com sucesso!", "success");
          carregarUrls();
          carregarMonitoramentos();
          atualizarGrafico();
        },
        error: function () {
          showToast("Erro ao excluir URL.");
        }
      });
    }

    function adicionarUrl(url) {
      $.ajax({
        url: "/api/sites",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ url }),
        success: function () {
          showToast("URL adicionada com sucesso!", "success");
          $("#nova-url").val("").removeClass("is-invalid");
          carregarUrls();
          carregarMonitoramentos();
          atualizarGrafico();
        },
        error: function () {
          showToast("Erro ao adicionar URL.");
        }
      });
    }

    $(document).ready(function () {
      ativarAba("dashboard");
      carregarUrls();
      carregarMonitoramentos();
      atualizarGrafico();

      $("#data-inicial, #data-final, #filtro-status").on("change", function () {
        atualizarGrafico();
      });

      $("#url-form").on("submit", function (e) {
        e.preventDefault();
        const url = $("#nova-url").val().trim();
        const urlPattern = /^https?:\/\/.+/i;
        if (!url || !urlPattern.test(url)) {
          $("#nova-url").addClass("is-invalid").focus();
          return;
        }
        adicionarUrl(url);
      });

      $("#nova-url").on("input", function () {
        $(this).removeClass("is-invalid");
      });

      let urlIdParaExcluir = null;
      const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));

      $(document).on("click", ".btn-sm", function () {
        urlIdParaExcluir = $(this).data("id");
        deleteModal.show();
      });

      $("#btnConfirmDelete").click(function () {
        if (urlIdParaExcluir) {
          excluirUrl(urlIdParaExcluir);
          urlIdParaExcluir = null;
          deleteModal.hide();
        }
      });

      $("#btnCancelDelete").click(function () {
        urlIdParaExcluir = null;
        deleteModal.hide();
      });
    });
</script>
</body>
</html>