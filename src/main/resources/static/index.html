<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitor Web - Dashboard Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Reset b치sico */
        * {
          box-sizing: border-box;
        }

        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #f0f4ff, #e7ebf7);
          margin: 0;
          height: 100vh;
          overflow: hidden;
          color: #212529;
        }

        .sidebar {
          height: 100vh;
          position: fixed;
          top: 0;
          left: 0;
          width: 260px;
          background-color: #2c3e50;
          padding-top: 2rem;
          display: flex;
          flex-direction: column;
          color: #ecf0f1;
          box-shadow: 3px 0 8px rgba(0,0,0,0.15);
          z-index: 1050;
          transition: width 0.3s ease;
        }

        .sidebar h4 {
          font-weight: 700;
          font-size: 1.6rem;
          margin-bottom: 2rem;
          text-align: center;
          user-select: none;
          letter-spacing: 1.2px;
          color: #3498db;
        }

        .sidebar a {
          color: #bdc3c7;
          padding: 1rem 1.75rem;
          text-decoration: none;
          font-weight: 600;
          font-size: 1.05rem;
          border-left: 5px solid transparent;
          transition: all 0.3s ease;
          user-select: none;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .sidebar a:hover,
        .sidebar a.active {
          background-color: #34495e;
          color: #ffffff;
          border-left-color: #3498db;
          font-weight: 700;
          text-shadow: 0 0 6px #3498dbaa;
        }

        .content {
          margin-left: 260px;
          height: 100vh;
          overflow-y: auto;
          padding: 2.5rem 3rem;
          background: #fff;
          box-shadow: inset 0 0 25px #dae3f1;
          border-radius: 12px 0 0 12px;
        }

        .tab-pane {
          display: none;
        }
        .tab-pane.active {
          display: block;
        }

        h2 {
          font-weight: 700;
          color: #2c3e50;
          border-bottom: 3px solid #3498db;
          padding-bottom: 0.3rem;
          margin-bottom: 2rem;
          user-select: none;
        }

        /* Cards de monitoramento */
        .monitor-card {
          border-radius: 12px;
          box-shadow: 0 4px 12px rgb(52 73 94 / 0.15);
          background-color: #fdfdff;
          padding: 1.5rem 2rem;
          margin-bottom: 1.3rem;
          transition: box-shadow 0.3s ease;
          cursor: default;
          border: 1px solid #e1e8f7;
          user-select: none;
        }
        .monitor-card:hover {
          box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .monitor-url {
          font-size: 1.2rem;
          font-weight: 700;
          word-break: break-word;
          color: #34495e;
        }

        .status-badge {
          font-size: 0.9rem;
          padding: 0.4em 0.85em;
          border-radius: 0.6rem;
          font-weight: 700;
          user-select: none;
          box-shadow: 0 0 6px #00000010;
          transition: background-color 0.3s ease;
          display: inline-block;
          min-width: 72px;
          text-align: center;
        }

        .status-ok {
          background-color: #d4edda;
          color: #155724;
          box-shadow: 0 0 8px #28a745aa;
        }

        .status-fail {
          background-color: #f8d7da;
          color: #721c24;
          box-shadow: 0 0 8px #dc3545aa;
        }

        .monitor-meta {
          font-size: 0.95rem;
          color: #7f8c8d;
          margin-top: 0.6rem;
          font-style: italic;
          user-select: none;
        }

        /* Bot칚o de excluir URLs */
        .btn-sm {
          font-size: 0.85rem;
          padding: 0.3rem 0.7rem;
          border-radius: 0.35rem;
          transition: background-color 0.3s ease;
        }
        .btn-sm:hover {
          background-color: #e74c3c;
          color: white;
        }

        /* Formul치rio URL */
        #url-form .input-group {
          max-width: 540px;
          box-shadow: 0 2px 12px rgb(52 152 219 / 0.15);
          border-radius: 0.5rem;
          overflow: hidden;
        }

        #url-form input.form-control {
          border: none;
          font-size: 1.05rem;
          padding-left: 1rem;
        }
        #url-form button.btn-primary {
          border-radius: 0;
          padding-left: 1.5rem;
          padding-right: 1.5rem;
          font-weight: 700;
          font-size: 1.05rem;
          transition: background-color 0.3s ease;
          box-shadow: none;
        }
        #url-form button.btn-primary:hover {
          background-color: #217dc1;
          box-shadow: 0 0 8px #217dc1aa;
        }

        /* Toasts */
        #toast-container {
          z-index: 1200;
        }

        /* Responsividade */
        @media (max-width: 991.98px) {
          .content {
            padding: 2rem 1.5rem;
            margin-left: 0;
            height: auto;
          }
          .sidebar {
            width: 100%;
            height: auto;
            position: relative;
            flex-direction: row;
            padding: 0.75rem 1rem;
            box-shadow: none;
          }
          .sidebar a {
            flex: 1 1 auto;
            font-size: 1rem;
            padding: 0.75rem 0.75rem;
            border-left: none;
            border-bottom: 3px solid transparent;
            text-align: center;
          }
          .sidebar a.active {
            border-left: none;
            border-bottom-color: #3498db;
            font-weight: 700;
            text-shadow: none;
          }
          .monitor-card {
            padding: 1.2rem 1.2rem;
          }
        }

        @media (max-width: 575.98px) {
          #url-form .input-group {
            max-width: 100%;
          }
        }
    </style>
</head>
<body>
<nav class="sidebar" role="navigation" aria-label="Menu principal">
    <h4 class="mb-3">游늵 MonitorWeb</h4>
    <a href="#" class="nav-link active" data-tab="dashboard" tabindex="0" id="dashboard-tab">Dashboard</a>
    <a href="#" class="nav-link" data-tab="monitoramentos" tabindex="0" id="monitoramentos-tab">Hist칩rico</a>
    <a href="#" class="nav-link" data-tab="urls" tabindex="0" id="urls-tab">Gerenciar URLs</a>
</nav>

<main class="content" role="main">
    <section id="dashboard" class="tab-pane active" role="tabpanel" aria-labelledby="dashboard-tab" tabindex="0">
        <h2>Vis칚o Geral</h2>

        <div class="row mb-4 gy-3">
            <div class="col-md-6">
                <label for="data-inicial" class="form-label">Filtrar por per칤odo:</label>
                <input type="date" id="data-inicial" class="form-control" aria-label="Data inicial filtro" />
            </div>
            <div class="col-md-6">
                <label for="data-final" class="form-label">at칠</label>
                <input type="date" id="data-final" class="form-control" aria-label="Data final filtro" />
            </div>
            <div class="col-md-6">
                <label for="filtro-status" class="form-label mt-3">Filtrar por status:</label>
                <select id="filtro-status" class="form-select" aria-label="Filtro de status">
                    <option value="todos" selected>Todos</option>
                    <option value="ok">OK (2xx)</option>
                    <option value="falha">Falha</option>
                </select>
            </div>
        </div>

        <canvas id="statusChart" aria-label="Gr치fico de status de monitoramento" role="img" style="max-height:300px;"></canvas>
    </section>

    <section id="monitoramentos" class="tab-pane" role="tabpanel" aria-labelledby="monitoramentos-tab" tabindex="0">
        <h2>Hist칩rico de Monitoramento</h2>
        <div id="monitor-container" aria-live="polite" aria-atomic="true" tabindex="0" style="max-height: 70vh; overflow-y: auto;">
            <!-- Cards preenchidos via JS -->
        </div>
    </section>

    <section id="urls" class="tab-pane" role="tabpanel" aria-labelledby="urls-tab" tabindex="0">
        <h2>Gerenciar URLs</h2>
        <form id="url-form" class="mb-4" aria-label="Adicionar nova URL para monitoramento" novalidate>
            <div class="input-group shadow-sm">
                <input
                        type="url"
                        class="form-control"
                        id="nova-url"
                        placeholder="https://exemplo.com"
                        aria-required="true"
                        aria-describedby="btn-adicionar-url"
                        required
                        pattern="https?://.+"
                        title="Digite uma URL v치lida come칞ando com http:// ou https://"
                />
                <button id="btn-adicionar-url" class="btn btn-primary" type="submit" aria-label="Adicionar URL">
                    Adicionar
                </button>
            </div>
            <div class="invalid-feedback mt-2">Por favor, insira uma URL v치lida.</div>
        </form>
        <ul class="list-group" id="lista-urls" aria-live="polite" aria-atomic="true" style="max-height: 60vh; overflow-y: auto;">
        </ul>
    </section>
</main>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1200;">
    <div id="toast-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Gerenciar abas
    $(".nav-link").click(function (e) {
      e.preventDefault();
      $(".nav-link").removeClass("active");
      $(this).addClass("active");
      $(".tab-pane").removeClass("active");
      const tabId = $(this).data("tab");
      $("#" + tabId).addClass("active");
      $("#" + tabId).focus();
    });

    const API_BASE = "";

    function showToast(message, type = 'danger') {
      const toastId = `toast-${Date.now()}`;
      const bgClass = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
      const toastHtml = `
        <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
          </div>
        </div>
      `;
      $("#toast-container").append(toastHtml);
      const toastEl = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
      toast.show();
      toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
    }

    function formatStatus(code) {
      if (code >= 200 && code < 300) {
        return `<span class="status-badge status-ok" title="Resposta OK">${code}</span>`;
      } else if (code === 0) {
        return `<span class="status-badge status-fail" title="Sem resposta">Falha</span>`;
      } else {
        return `<span class="status-badge status-fail" title="Erro HTTP">${code}</span>`;
      }
    }

    function formatTime(ms) {
      return ms > 0 ? `${ms} ms` : '-';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return dateStr.replace('T', ' ').split('.')[0];
    }

    let monitorData = [];

    function carregarMonitoramentos() {
      $.ajax({
        url: `${API_BASE}/api/monitor/todos`,
        type: "GET",
        success: function (data) {
          monitorData = data;
          atualizarMonitoramentos();
          atualizarGrafico();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error("Erro ao carregar monitoramentos:", textStatus, errorThrown);
          showToast("Erro ao carregar monitoramentos: " + textStatus);
        },
      });
    }

    function atualizarMonitoramentos() {
      const container = $("#monitor-container").empty();

      let filtered = monitorData.slice();
      const dataInicial = $("#data-inicial").val();
      const dataFinal = $("#data-final").val();
      const filtroStatus = $("#filtro-status").val();

      if (dataInicial) {
        filtered = filtered.filter(m => new Date(m.checkedAt) >= new Date(dataInicial));
      }
      if (dataFinal) {
        let dtFinal = new Date(dataFinal);
        dtFinal.setHours(23,59,59,999);
        filtered = filtered.filter(m => new Date(m.checkedAt) <= dtFinal);
      }
      if (filtroStatus === "ok") {
        filtered = filtered.filter(m => m.statusCode >= 200 && m.statusCode < 300);
      } else if (filtroStatus === "falha") {
        filtered = filtered.filter(m => !(m.statusCode >= 200 && m.statusCode < 300));
      }

      if (!filtered.length) {
        container.append('<p class="text-muted fst-italic">Nenhum monitoramento encontrado para os filtros selecionados.</p>');
        return;
      }

      filtered.forEach(({ url, statusCode, responseTime, checkedAt }) => {
        container.append(`
          <article class="monitor-card" tabindex="0" aria-label="Monitoramento da URL ${url}">
            <div class="monitor-url">${url}</div>
            <div>
              Status: ${formatStatus(statusCode)} &nbsp;&nbsp;
              Tempo: <span title="Tempo de resposta">${formatTime(responseTime)}</span>
            </div>
            <div class="monitor-meta">Verificado em: ${formatDate(checkedAt)}</div>
          </article>
        `);
      });
    }

    let chart = null;

    function atualizarGrafico() {
      if (!monitorData.length) return;

      const countsByDate = {};
      const dataInicial = $("#data-inicial").val() ? new Date($("#data-inicial").val()) : null;
      const dataFinal = $("#data-final").val() ? new Date($("#data-final").val()) : new Date();

      const dataMin = dataInicial || new Date(dataFinal.getTime() - (7*24*60*60*1000));
      const dataMax = dataFinal;

      for(let d = new Date(dataMin); d <= dataMax; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().slice(0,10);
        countsByDate[key] = { ok: 0, falha: 0 };
      }

      monitorData.forEach(m => {
        const dateKey = m.checkedAt.slice(0,10);
        const dateObj = new Date(dateKey);
        if(dateObj < dataMin || dateObj > dataMax) return;
        if (!(dateKey in countsByDate)) countsByDate[dateKey] = { ok:0, falha:0 };

        if (m.statusCode >= 200 && m.statusCode < 300) {
          countsByDate[dateKey].ok++;
        } else {
          countsByDate[dateKey].falha++;
        }
      });

      const labels = Object.keys(countsByDate).sort();
      const okData = labels.map(date => countsByDate[date].ok);
      const failData = labels.map(date => countsByDate[date].falha);

      const ctx = document.getElementById('statusChart').getContext('2d');
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'OK (2xx)',
              data: okData,
              backgroundColor: 'rgba(40, 167, 69, 0.8)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Falha',
              data: failData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: true,
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: { precision:0 }
            }
          },
          plugins: {
            legend: { labels: { boxWidth: 15, padding: 15 } },
            tooltip: { enabled: true, mode: 'index', intersect: false }
          }
        }
      });
    }

    function carregarUrls() {
      $.ajax({
        url: `${API_BASE}/api/sites`,
        type: "GET",
        success: function (data) {
          const lista = $("#lista-urls").empty();
          if (!data.length) {
            lista.append('<li class="list-group-item text-muted fst-italic">Nenhuma URL cadastrada.</li>');
            return;
          }
          data.forEach(({ id, url }) => {
            lista.append(`
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span class="text-truncate" style="max-width: 85%;">${url}</span>
                <button
                  class="btn btn-sm btn-outline-danger"
                  aria-label="Excluir URL ${url}"
                  onclick="removerUrl(${id})"
                  title="Excluir"
                >
                  &times;
                </button>
              </li>
            `);
          });
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error("Erro ao carregar URLs:", textStatus, errorThrown);
          showToast("Erro ao carregar URLs: " + textStatus);
        },
      });
    }

    $("#url-form").submit(function (e) {
      e.preventDefault();

      const inputUrl = $("#nova-url")[0];
      if (!inputUrl.checkValidity()) {
        inputUrl.classList.add("is-invalid");
        return;
      } else {
        inputUrl.classList.remove("is-invalid");
      }

      const url = $("#nova-url").val();
      $.ajax({
        url: `${API_BASE}/api/sites`,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ url }),
        success: function () {
          $("#nova-url").val("");
          carregarUrls();
          carregarMonitoramentos();
          showToast("URL adicionada com sucesso!", "success");
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error("Erro ao adicionar URL:", textStatus, errorThrown);
          showToast("Seu limite de sites acabou.");
        },
      });
    });

    function removerUrl(id) {
      if (!confirm("Confirma exclus칚o desta URL?")) return;
      $.ajax({
        url: `${API_BASE}/api/sites/${id}`,
        type: "DELETE",
        success: function () {
          carregarUrls();
          showToast("URL removida com sucesso!", "success");
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error("Erro ao remover URL:", textStatus, errorThrown);
          showToast("Erro ao remover URL: " + textStatus);
        },
      });
    }

    $("#data-inicial, #data-final, #filtro-status").change(function() {
      atualizarMonitoramentos();
      atualizarGrafico();
    });

    setInterval(() => {
      carregarMonitoramentos();
      carregarUrls();
    }, 10000);

    $(document).ready(() => {
      carregarMonitoramentos();
      carregarUrls();
    });
</script>
</body>
</html>